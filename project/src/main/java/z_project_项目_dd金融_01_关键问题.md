# 数据中台
## flink场景

## redis存储

## flink消费延迟太高，消息积压
火焰图看
修改并发度
### 内存占比突然占比90%
分析
## 图谱
三度
三角关系
社区
### session重试

### 监控

### qps量

### session池

### 查询语句查询超时

### 数据批量导入

### 导入逻辑

### nebula
连接池

### nebula查询优化
查询量太大,请求超时,服务宕机
1.数据empty导致where语句匹配数据量大
2. fetch , match
### 导入优化
1.裂变推荐数据数据量太大

# 名单
## 缓存旁路场景
## redis缓存场景
## 数据库分表分库场景
## 分布式锁场景
## 分布式事务场景

## 倒名单
# 三方
## 异步查缓存

# 工作流

## 空跑
空跑工作流

## 跑批
跑批工作流

## 压单

## 修单

# 案调系统

# 监控
## 降噪

## 灵敏度

# 技术
## 日志脱敏
## binlog写入
# 难点case
## 问题1 超时
很多工作流某些任务耗时超过2s,同一个任务大部分耗时1ms左右
### 分析
1.流量高峰?分析发现流量低峰也有出现
2.redis耗时,分析慢查询日志发现redis未超时,请求成功,redis请求成功,打印耗时2s
3.过滤耗时>500ms的日志,发现附近都有耗时的大特征解析,2MB.为什么大特征解析会影响其他特征读取?
### 方案
1.策略下掉大特征
2.优化特征解析过程
#实时特征获取不到

## 问题2 特征延迟
每天2:00~4:00获取不到特征
### 分析
查看生产端消费延时,延时严重
查看输入500/s,输出情况200/s
查看buffer pool,100%
cpu使用情况,90%
算子流入流出,2000/s
kafka消费 1m/s

查看配置,taskmananger 1,slot 1,cpu 1
优化配置

### 方案
## 问题3 redis内存
Redis内存短时间暴涨,内存翻倍,报警

## 地理位置信息mq流量大方案
![img_1.png](img_1.png)
1.定位系统流量瓶颈,上游清洗(能抗),业务qps(能抗),下游清洗(瓶颈),特征加工(瓶颈)
2.缩小有效流量范围,过滤无效流量,根据有效业务字段过滤,uid+经纬度,经纬度为0
3.缩减下游链路,定制化优化清洗逻辑
## 特征值的key太大

## 问题4 nebula 大流量耗性能问题
1)sql拆分,优化好性能的sql,
2)nebula session会话设置较少60,支持更高并发度600
3)串行化问题,串行化报错

## 问题5 消息积压问题
1)监控告警积压
2)提高并发度
3)火焰图分析函数方法
4)优化耗时函数,日志
5)提高并发度无效,查看下游积压，下游生产情况
![img_3.png](img_3.png)
6)分析kafka lag,稳定在300+, qps:60+
7)反馈监控问题
8)message ts生产有问题,和现在相差几小时
![img_2.png](img_2.png)

